{% from "partials/stat_bar.html" import stat_bar %}
{% set active_group = active_group if active_group is defined else "all" %}

<div id="card-metrics" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">

  {# Comparison group toggles #}
  {% set groups = [
    ("all",        "All MPs"),
    ("party",      politician.party or "Same Party"),
    ("government", "Government"),
    ("opposition", "Opposition"),
  ] %}
  <div class="flex items-center gap-2 flex-wrap mb-5">
    <span class="text-xs font-semibold uppercase tracking-widest text-gray-400 mr-1">Compare to:</span>
    {% for g_key, g_label in groups %}
    <button
      hx-get="/api/card/{{ politician.slug }}?group={{ g_key }}"
      hx-target="#card-metrics"
      hx-swap="outerHTML"
      class="text-xs px-3 py-1.5 rounded-full font-semibold border transition-colors
             {% if active_group == g_key %}
               bg-gray-900 text-white border-gray-900
             {% else %}
               bg-white text-gray-500 border-gray-200 hover:border-gray-400
             {% endif %}"
    >
      {{ g_label }}
    </button>
    {% endfor %}
  </div>

  <div class="space-y-6">

    {# Voting Attendance #}
    {{ stat_bar(
      label="Voting Attendance",
      display_value=metrics.attendance | round(1),
      percentile=percentiles.get("attendance") if rankings_available else none,
      unit="%",
      sublabel=metrics.votes_cast | string + " of " + metrics.total_votes | string + " votes this session",
      distribution=distributions.get("attendance") if distributions is defined else none
    ) }}

    {# Party Loyalty #}
    {% if metrics.party_loyalty is none %}
      {{ stat_bar(
        label="Party Loyalty",
        display_value="",
        percentile=none,
        na=true
      ) }}
    {% else %}
      {{ stat_bar(
        label="Party Loyalty",
        display_value=metrics.party_loyalty | round(1),
        percentile=percentiles.get("party_loyalty") if rankings_available else none,
        unit="%",
        sublabel="Votes with " + (politician.party or "party") + " majority (excl. free votes)",
        distribution=distributions.get("party_loyalty") if distributions is defined else none
      ) }}
    {% endif %}

    {# Bills Sponsored #}
    {{ stat_bar(
      label="Bills Sponsored",
      display_value=metrics.bills_sponsored,
      percentile=percentiles.get("bills_sponsored") if rankings_available else none,
      sublabel="this session",
      distribution=distributions.get("bills_sponsored") if distributions is defined else none
    ) }}

    {# Debate Participation #}
    {{ stat_bar(
      label="Debate Participation",
      display_value=metrics.debate_speeches,
      percentile=percentiles.get("debate_speeches") if rankings_available else none,
      unit=" speeches",
      sublabel="recorded in Hansard this session",
      distribution=distributions.get("debate_speeches") if distributions is defined else none
    ) }}

  </div>

  {% if metrics.bills_list %}
  <div class="mt-6 pt-5 border-t border-gray-100">
    <p class="text-xs font-semibold uppercase tracking-widest text-gray-400 mb-2">Bills Sponsored</p>
    <ul class="space-y-1">
      {% for bill in metrics.bills_list %}
      <li class="text-xs text-gray-600">
        <span class="font-semibold text-gray-800">{{ bill.number }}</span>
        {% if bill.name %} — {{ bill.name[:80] }}{% if bill.name | length > 80 %}…{% endif %}{% endif %}
        {% if bill.introduced %}<span class="text-gray-400 ml-1">({{ bill.introduced[:4] }})</span>{% endif %}
      </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  {% if not rankings_available %}
  <p class="text-center text-xs text-gray-400 mt-5 pt-4 border-t border-gray-100">
    Percentile rankings are being computed in the background. Reload in a few minutes.
  </p>
  {% else %}
  <p class="text-center text-xs text-gray-300 mt-5">
    {% if active_group == "all" %}
      Ranked against all current MPs · Session {{ session }}
    {% elif active_group == "party" %}
      Ranked within {{ politician.party or "same party" }} · Session {{ session }}
    {% elif active_group == "government" %}
      Ranked within government MPs · Session {{ session }}
    {% elif active_group == "opposition" %}
      Ranked within opposition MPs · Session {{ session }}
    {% endif %}
  </p>
  {% endif %}

  {# Metric descriptions #}
  <details class="mt-5 pt-4 border-t border-gray-100 group">
    <summary class="text-xs font-semibold uppercase tracking-widest text-gray-400 cursor-pointer select-none list-none flex items-center justify-between">
      <span>About these metrics</span>
      <svg class="w-3.5 h-3.5 text-gray-300 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"/>
      </svg>
    </summary>
    <dl class="mt-3 space-y-3">
      <div>
        <dt class="text-xs font-semibold text-gray-700">Voting Attendance</dt>
        <dd class="text-xs text-gray-500 mt-0.5">The percentage of recorded votes in this parliamentary session where the MP cast a Yes or No ballot. Paired votes (a procedural mutual abstention between two MPs from opposing sides) and absences are not counted as attendance.</dd>
      </div>
      <div>
        <dt class="text-xs font-semibold text-gray-700">Party Loyalty</dt>
        <dd class="text-xs text-gray-500 mt-0.5">How often the MP voted with their party's majority position. Free votes — where the party allowed members to vote their conscience — are excluded. Paired votes are excluded entirely; abstentions count against loyalty.</dd>
      </div>
      <div>
        <dt class="text-xs font-semibold text-gray-700">Bills Sponsored</dt>
        <dd class="text-xs text-gray-500 mt-0.5">The number of private member's bills introduced by this MP in the current session. Government bills introduced by cabinet ministers on behalf of the Crown are not included.</dd>
      </div>
      <div>
        <dt class="text-xs font-semibold text-gray-700">Debate Participation</dt>
        <dd class="text-xs text-gray-500 mt-0.5">The number of speeches recorded in Hansard (the official transcript of parliamentary debates) for this session. Includes statements, questions during Question Period, and contributions to debate on legislation.</dd>
      </div>
    </dl>
  </details>

</div>
